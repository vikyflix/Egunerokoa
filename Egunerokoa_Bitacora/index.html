<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Egunerokoa - SAU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        body { background-color: #f4f7f6; color: #2d3436; font-size: 0.95rem; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        .quick-add-btn { 
            width: 100%; padding: 15px; text-align: left; background: white; 
            border: 1px solid #dee2e6; transition: all 0.2s; font-weight: 600; margin-bottom: 10px;
            border-left: 4px solid #6c757d; border-radius: 8px;
        }
        .quick-add-btn:hover { background: #f8f9fa; transform: translateY(-2px); }
        
        .form-container { display: none; background: #fff; border: 2px solid #4a90e2; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .form-container.active { display: block; animation: fadeIn 0.3s; }
        
        .remove-btn { color: #feb2b2; cursor: pointer; transition: 0.2s; }
        .remove-btn:hover { color: #f56565; }

        #loginOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .data-label { font-weight: bold; color: #718096; font-size: 0.75rem; text-transform: uppercase; margin-right: 5px; }
        .entry-detail { background: #f8fafc; padding: 2px 8px; border-radius: 4px; margin-right: 5px; display: inline-block; margin-bottom: 2px; border: 1px solid #edf2f7; }
        
        .overlay-style {
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99999;
            justify-content: center; align-items: center;
        }
        .overlay-style.is-visible { display: flex; }

        .filter-card { background: white; padding: 25px; border-radius: 15px; min-width: 350px; max-height: 80vh; overflow-y: auto; }
        
        .badge-time { background-color: #e2e8f0; color: #4a5568; font-weight: bold; }
        .key-badge { font-size: 0.8rem; padding: 5px 10px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="card p-5" style="width: 380px;">
            <h4 class="text-center mb-4">Control de Acceso</h4>
            <input type="password" id="pass" class="form-control mb-3" placeholder="Contraseña">
            <button onclick="login()" class="btn btn-primary w-100">Entrar</button>
        </div>
    </div>

    <div id="filterOverlay" class="overlay-style">
        <div id="filter-card" class="filter-card shadow-lg">
            </div>
    </div>

    <div id="mainApp" style="display:none">
        <nav class="navbar navbar-dark bg-dark px-4 mb-4">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-database me-2 text-info"></i> Egunerokoa</span>
            <div class="d-flex gap-2">
                <span id="currentUser" class="btn btn-outline-info btn-sm"></span>
                <button onclick="exportJSON()" class="btn btn-outline-info btn-sm">Backup JSON</button>
                <button id="menuButton" class="btn btn-outline-light btn-sm"><i class="fas fa-cog"></i> Ajustes</button>
                <button onclick="location.reload()" class="btn btn-outline-danger btn-sm">Salir</button>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <div class="col-md-8">
                    <div class="card p-4 mb-4">
                        <h5 class="mb-4 fw-bold">Registrar Actividad</h5>
                        <div class="row" id="categoryButtonsContainer"></div>

                        <div id="dynamicForm" class="form-container shadow">
                            <h6 id="formTitle" class="fw-bold mb-3 border-bottom pb-2"></h6>
                            <div id="formFields" class="row g-3"></div>
                            <div class="mt-4">
                                <button class="btn btn-primary px-4" onclick="saveEntry()">Guardar</button>
                                <button class="btn btn-light" onclick="$('#dynamicForm').removeClass('active')">Cancelar</button>
                            </div>
                        </div>
                    </div>

                    <div class="card p-3 mb-4 border-start border-primary border-4">
                        <h6 class="fw-bold d-flex justify-content-between">
                            <span><i class="fas me-2 text-warning"></i> Control de Llaves</span>
                            <small class="text-muted fw-normal" style="font-size: 0.7rem;">ESTADO ACTUAL</small>
                        </h6>
                        <div id="keyList" class="row g-2 mt-1"></div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card p-3 mb-4 h-100">
                                <h6 class="fw-bold border-bottom pb-2">Tareas Pendientes</h6>
                                <div class="input-group input-group-sm mb-3">
                                    <input type="text" id="t-name" class="form-control" placeholder="Nombre de tarea...">
                                    <input type="text" id="t-date" class="form-control" placeholder="Fecha">
                                    <input type="text" id="t-desc" class="form-control" placeholder="Descripcion">
                                    <input type="text" id="t-ppl" class="form-control" placeholder="Participantes">
                                    <input type="text" id="t-state" class="form-control" placeholder="Estado">
                                    <button class="btn btn-dark" onclick="quickEntry('tasks', {name: $('#t-name').val(), date: $('#t-date').val(), desc: $('#t-desc').val(), ppl: $('#t-ppl').val(), state: $('#t-state').val()})">Añadir</button>
                                </div>
                                <div id="list-tasks"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3 mb-4 h-100">
                                <h6 class="fw-bold border-bottom pb-2">Agenda / Reuniones</h6>
                                <div class="input-group input-group-sm mb-3">
                                    <input type="time" id="m-time" class="form-control">
                                    <input type="text" id="m-name" class="form-control" placeholder="Asunto...">
                                    <button class="btn btn-dark" onclick="quickEntry('meetings', {time: $('#m-time').val(), name: $('#m-name').val()})">+</button>
                                </div>
                                <div id="list-meetings"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                            <span>Actividad de Hoy</span>
                            <span class="badge bg-primary rounded-pill" id="todayCount">0</span>
                        </div>
                        <div class="card-body p-0 overflow-auto" style="max-height: 80vh;">
                            <div id="list-bitacora" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-5">
                <div class="col-12 mb-5">
                    <div class="card border-0 shadow-lg">
                        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-3">
                            <span class="h6 mb-0"><i class="fas me-2 text-info"></i> Auditoría / Histórico</span>
                            <div class="d-flex align-items-center gap-2">
                                <span class="small">Filtrar por fecha:</span>
                                <input type="date" id="histDate" class="form-control form-control-sm w-auto">
                            </div>
                        </div>
                        <div class="card-body bg-light" id="histContent">
                            <p class="text-center text-muted my-5">Seleccione una fecha para visualizar el reporte completo de ese día.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Añadiendo lineas a este objeto, se añaden campos para formularios principales,
        // Se añaden los campos etc aqui y se generan con JS
        const config = {
            'Trabajo / Tiempo': { color: 'text-primary', icon: '', fields: [{n:'cli', l:'Cliente', t:'text'}, {n:'m', l:'Tarea', t:'text'}, {n:'h', l:'Horas', t:'number'}] },
            'Retraso': { color: 'text-warning', icon: '', fields: [{n:'p', l:'Persona', t:'text'}, {n:'h', l:'Horas', t:'text'}, {n:'m', l:'Motivo', t:'text'}] },
            'Hitos': { color: 'text-success', icon: '', fields: [{n:'cli', l:'Cliente', t:'text'}, {n:'m', l:'Logro Reseñable', t:'text'}] },
            'Mejoras': { color: 'text-info', icon: '', fields: [{n:'m', l:'Propuesta', t:'text'}] },
            'Necesidades': { color: 'text-danger', icon: '', fields: [{n:'m', l:'Descripción', t:'text'}] },
            'Seguimiento': { color: 'text-secondary', icon: '', fields: [{n:'cli', l:'Cliente', t:'text'}, {n:'acc', l:'Acción', t:'text'}, {n:'next', l:'Pendiente', t:'text'}] },
            'Falta': { color: 'text-danger', icon: '', fields: [{n:'p', l:'Persona', t:'text'}, {n:'m', l:'Motivo', t:'text'}] },
            'Enfermo': { color: 'text-info', icon: '', fields: [{n:'p', l:'Persona', t:'text'}, {n:'baja', l:'¿Baja Médica?', t:'check'}] },
            'Incidencias': {color: 'text-info',icon: '', fields: [{n:'s',l:'Servicio',t:'text'},{n:'i',l:'Incidencia',t:'text'},{n:'t',l:'Tipo',t:'text'}]},
            'Implantaciones / Gestion de cambio': {color: 'text-info',icon: '', fields: [{n:'p',l:'Proyecto',t:'text'},{n:'d',l:'Descripcion',t:'text'},{n:'e',l:'Extra',t:'text'}]},
            'Correos': {color: 'text-info',icon: '', fields: [{n:'s',l:'Servicio',t:'text'},{n:'e',l:'Email',t:'text'},{n:'n',l:'Nº',t:'number'}]}
        };

        // Esta estructura es donde se guarda/almacena toda la información. 
        // El estado actual no representa la información almacenada, pero si se usa esta variable junto con el localStorage del navegador.
        // En un futuro se migrara a un server MySQL
        let data = JSON.parse(localStorage.getItem('egunerokoa_v3')) || {
            bitacora: [], 
            tasks: [], 
            meetings: [], 
            keys: [
                { id: 1, name: "Oficina", status: "In", holder: "Oficina" },
                { id: 2, name: "Oficina", status: "In", holder: "Oficina" }
            ],
            profiles: {
                "Deitu": Object.keys(config), 
                "SaP": ["Trabajo / Tiempo", "Retraso", "Hitos", "Seguimiento"], 
                "default": ["Hitos"]
            },
            visible: Object.keys(config), 
            currentUser: "default" 
        };

        // Variables para coger la fecha y la hora actual. Principalmente para los registros
        const today = () => new Date().toLocaleDateString('en-CA');
        const now = () => new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});


        // Esta funcion actualiza y sincroniza la información que se ve en pantalla con la información que esta almacenada.
        function sync() { 
            localStorage.setItem('egunerokoa_v3', JSON.stringify(data)); 
            render(); 
            renderButtons();
            renderKeys();
        }

        // Funcion que gestiona el login, 
        // por el momento esta "hardcoded"
        // Principalmente se actualizan los campos que se han de mostrar en cada perfil, asi como el nombre arriba
        function login() {
            let pass = $('#pass').val();
            if (pass === 'deitu') data.currentUser = "Deitu";
            else if (pass === 'SaP') data.currentUser = "SaP";
            else data.currentUser = "default";

            data.visible = data.profiles[data.currentUser] || data.profiles["default"];
            $('#loginOverlay').hide();
            $('#mainApp').show();
            console.log($('#currentUser').text())
            $('#currentUser').text(data.currentUser);
            sync(); 
        }

        // Funcion que gestiona el manejo de llaves, funcion simple donde le pones quien la tiene y cambia de persona a Oficina
        function toggleKey(id) {
            let key = data.keys.find(k => k.id === id);
            if (key.status === "In") {
                let person = prompt("¿Quién se lleva la llave?");
                if (!person) return;
                key.status = "Out"; key.holder = person;
            } else {
                key.status = "In"; key.holder = "Oficina";
            }
            sync();
        }

       // Funcion para actualizar visualmente en funcion a quien o donde este la llave
        function renderKeys() {
            //console.log(data.keys)
            $('#keyList').html(data.keys.map(k => `
                <div class="col-md-4">
                    <div class="p-2 border rounded d-flex justify-content-between align-items-center bg-white shadow-sm">
                        <div style="line-height:1.1">
                            <div class="small fw-bold">${k.name}</div>
                            <small class="text-muted">${k.holder}</small>
                        </div>
                        <button onclick="toggleKey(${k.id})" class="btn btn-sm ${k.status === 'In' ? 'btn-outline-success' : 'btn-warning'} py-0 px-2" style="font-size:0.7rem">
                            ${k.status === 'In' ? 'Libre' : 'Ocupada'}
                        </button>
                    </div>
                </div>
            `).join(''));
        }

        // Gestion dinamica de los formularios
        let activeCat = null;
        function setupForm(cat) {
            activeCat = cat;
            $('#formTitle').html(`<i class="fas ${config[cat].icon || ''} me-2"></i> ${cat}`);
            $('#formFields').html(config[cat].fields.map(f => `
                <div class="${f.t === 'check' ? 'col-12' : 'col-md-6'}">
                    ${f.t === 'check' ? `
                        <div class="form-check p-2 border rounded bg-light mt-2">
                            <input class="form-check-input ms-2 me-2" type="checkbox" id="in_${f.n}">
                            <label class="form-check-label fw-bold small" for="in_${f.n}">${f.l}</label>
                        </div>
                    ` : `
                        <label class="small fw-bold text-muted">${f.l}</label>
                        <input id="in_${f.n}" type="${f.t}" class="form-control form-control-sm" placeholder="${f.l}">
                    `}
                </div>
            `).join(''));
            $('#dynamicForm').addClass('active');
        }

        // Funcion para almacenar principalmente las reuniones y las tareas
        function saveEntry() {
            let entry = { id: Date.now(), type: activeCat, date: today(), time: now() };
            config[activeCat].fields.forEach(f => {
                const el = $(`#in_${f.n}`);
                entry[f.n] = f.t === 'check' ? el.is(':checked') : el.val();
            });
            data.bitacora.push(entry);
            $('#dynamicForm').removeClass('active');
            sync();
        }

        // Funcion que gestiona los detalles de la lista del historico
        function getDetailHtml(e) {
            let html = '';
            const conf = config[e.type];
            if(!conf) return "";
            conf.fields.forEach(f => {
                const val = e[f.n];
                if(f.t === 'check') {
                    if(val) html += `<span class="badge bg-danger">SÍ</span> `;
                } else if(val) {
                    html += `<div class="entry-detail"><span class="data-label">${f.l}:</span>${val}</div>`;
                }
            });
            return html;
        }

        // Gestion renderizado dinamico del historial
        function render() {
            const isToday = (e) => e.date === today();
            const todayBits = data.bitacora.filter(isToday);
            $('#todayCount').text(todayBits.length);

            $('#list-bitacora').html(todayBits.slice().reverse().map(e => `
                <div class="list-group-item p-3 border-bottom">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="fw-bold ${config[e.type]?.color || ''} small text-uppercase">
                            <i class="fas ${config[e.type]?.icon || 'fa-circle'} me-1"></i> ${e.type}
                        </span>
                        <span class="badge badge-time rounded-pill">${e.time}</span>
                    </div>
                    <div class="mt-1">${getDetailHtml(e)}</div>
                    <div class="text-end mt-2"><i class="fas fa-trash-alt remove-btn" style="font-size:0.8rem" onclick="remove(${e.id}, 'bitacora')"></i></div>
                </div>
            `).join('') || '<p class="text-center text-muted p-4 small">No hay actividad hoy</p>');

            $('#list-tasks').html(data.tasks.filter(isToday).map(e => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2 small">
                    <span><i class="far fa-square me-2 text-muted"></i> ${e.name}</span>
                    <span><i class="far fa-square me-2 text-muted"></i> ${e.date}</span>
                    <span><i class="far fa-square me-2 text-muted"></i> ${e.desc}</span>
                    <span><i class="far fa-square me-2 text-muted"></i> ${e.ppl}</span>
                    <span><i class="far fa-square me-2 text-muted"></i> ${e.state}</span>
                    <i class="fas fa-times remove-btn" onclick="remove(${e.id}, 'tasks')"></i>
                </div>
            `).join(''));
            //console.log(data.tasks.map(e => console.log(e)))
            
            $('#list-meetings').html(data.meetings.filter(isToday).map(e => `
                <div class="d-flex justify-content-between border-bottom py-2 small">
                    <span><b class="text-primary me-2">${e.time}</b> ${e.name}</span>
                    <i class="fas fa-times remove-btn" onclick="remove(${e.id}, 'meetings')"></i>
                </div>
            `).join(''));
        }

        // Gestion renderizado dinamico de los botones en base a que se ha elegido mostrar para ese perfil
        // Se gestiona tambien si el boton de "Ajustes" aparece o no
        function renderButtons() {
            data.currentUser === 'Deitu' ? $('#menuButton').show() : $('#menuButton').hide();
            let html = "";
            let currentVisible = data.visible || [];

            currentVisible.forEach(cat => {
                if(!config[cat]) return;
                html += `
                    <div class="col-md-4 mb-2">
                        <button class="quick-add-btn h-100" onclick="setupForm('${cat}')">
                            <i class="fas ${config[cat].icon || ''} me-2 ${config[cat].color}"></i>
                            <span class="small">${cat}</span>
                        </button>
                    </div>`;
            });
            $('#categoryButtonsContainer').html(html);
        }


        // Muestra el menu/contexto que gestiona el visalizado de los ajustes
        // Se añaden checkboxes en base a el campo "Config" mas arriba
        $('#menuButton').click(function() {
            $('#filterOverlay').addClass('is-visible');
            let html = `
                <h5 class="fw-bold mb-3"><i class="fas fa-user-shield me-2"></i> Ajustes de Perfiles</h5>
                <label class="small fw-bold mb-1">Seleccionar Perfil:</label>
                <select id="profileToEdit" class="form-select mb-3">
                    <option value="Deitu">Deitu (deitu)</option>
                    <option value="SaP">SaP (sap)</option>
                    <option value="default">Público (Otros)</option>
                </select>
                <div class="small text-muted mb-2">Selecciona qué funcionalidades están disponibles:</div>
                <div id="checkboxContainer" class="border p-3 rounded mb-3 bg-light" style="max-height:250px; overflow-y:auto;"></div>
                <div class="d-flex gap-2">
                    <button id="saveConfig" class="btn btn-primary w-100">Guardar</button>
                    <button id="closeBtn" class="btn btn-secondary w-100">Cerrar</button>
                </div>`;
            $('#filter-card').html(html);
            loadProfileBoxes('Deitu');
        });

        function loadProfileBoxes(role) {
            let html = Object.keys(config).map(cat => {
                let checked = data.profiles[role] && data.profiles[role].includes(cat) ? "checked" : "";
                return `
                    <div class="form-check mb-1">
                        <input class="form-check-input" type="checkbox" id="chk_${cat}" ${checked}>
                        <label class="form-check-label small" for="chk_${cat}">${cat}</label>
                    </div>`;
            }).join('');
            $('#checkboxContainer').html(html);
        }

        $(document).on('change', '#profileToEdit', function() { loadProfileBoxes($(this).val()); });

        $(document).on('click', '#saveConfig', function() {
            let role = $('#profileToEdit').val();
            let selected = [];
            $('#checkboxContainer input:checked').each(function() {
                selected.push($(this).attr('id').replace('chk_', ''));
            });
            
            data.profiles[role] = selected;
            if (data.currentUser === role) data.visible = selected;
            
            sync();
            alert("Perfil " + role + " actualizado correctamente.");
            $('#filterOverlay').removeClass('is-visible');
        });


        $(document).on('click', '#closeBtn', function() { $('#filterOverlay').removeClass('is-visible'); });


        function quickEntry(cat, obj) {
            if(!Object.values(obj)[0]) return;
            //console.log(obj)
            obj.id = Date.now(); obj.date = today();
            data[cat].push(obj); 
            sync();
            $('#t-name, #t-desc, #t-date, #m-name, #t-ppl, #t-state').val('');
        }

        function remove(id, cat) {
            if(confirm('¿Eliminar este registro?')) {
                data[cat] = data[cat].filter(i => i.id !== id);
                sync();
                if($('#histDate').val()) loadHistory($('#histDate').val());
            }
        }

        function loadHistory(d) {
            const filter = (arr) => arr.filter(x => x.date === d);
            const b = filter(data.bitacora);
            const t = filter(data.tasks);
            const m = filter(data.meetings);

            $('#histContent').html(`
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="bg-white p-3 rounded shadow-sm border-top border-primary border-3 h-100">
                            <h6 class="fw-bold mb-3"><i class="fas fa-stream me-2 text-primary"></i> Actividad del Día</h6>
                            ${b.map(e => `<div class="p-2 border-bottom mb-2 small">
                                <div class="d-flex justify-content-between"><b>${e.time}</b> <span class="${config[e.type]?.color || ''} fw-bold">${e.type}</span></div>
                                <div class="mt-1">${getDetailHtml(e)}</div>
                            </div>`).join('') || '<p class="text-muted small">Sin registros.</p>'}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="bg-white p-3 rounded shadow-sm h-100 border-top border-dark border-3">
                            <h6 class="fw-bold mb-3">Tareas</h6>
                            ${t.map(e => `<div class="small mb-2 p-1 border-bottom">✓ ${e.desc}</div>`).join('') || '<p class="text-muted small">---</p>'}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="bg-white p-3 rounded shadow-sm h-100 border-top border-info border-3">
                            <h6 class="fw-bold mb-3">Reuniones</h6>
                            ${m.map(e => `<div class="small mb-2 p-1 border-bottom"><b>${e.time}</b> ${e.name}</div>`).join('') || '<p class="text-muted small">---</p>'}
                        </div>
                    </div>
                </div>
            `);
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `Backup_${today()}.json`; a.click();
        }

        $('#histDate').on('change', function() { loadHistory($(this).val()); });
        $(document).ready(sync);
    </script>
</body>
</html>

