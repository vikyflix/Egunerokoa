<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Egunerokoa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet"  href="css.css">
    
    <style>
        .scrollable-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .incident-card {
            transition: all 0.2s;
            cursor: pointer;
            border-left: 4px solid transparent;
        }
        .incident-card:hover {
            background-color: #f8f9fa;
            border-left-color: #0d6efd;
        }
        .incident-card.selected {
            background-color: #e7f1ff;
            border-left-color: #0d6efd;
        }
        .quick-detail-form {
            display: none;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-top: 10px;
        }
        .quick-detail-form.active {
            display: block;
        }
        .badge-tipo {
            min-width: 100px;
            padding: 8px 12px;
            font-size: 0.85rem;
        }
        .bitacora-summary {
            font-size: 0.9rem;
        }
        .quick-add-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            text-align: left;
            border-left: 4px solid transparent;
        }
        .quick-add-btn:hover {
            border-left-color: #0d6efd;
        }
    </style>
</head>
<body>
    
    <div id="loginOverlay" onload="login()">
        <div class="card p-5" style="width: 400px;">
            <h3 class="text-center mb-4"><i class="fas fa-user-shield"></i>Login Responsable</h3>
            <div class="mb-3">
                <label>Usuario</label>
                <input type="text" id="username" class="form-control" placeholder="usuario">
            </div>
            <div class="mb-3">
                <label>Password</label>
                <input type="password" id="password" class="form-control" placeholder="contraseña">
            </div>
            <button onclick="login()" class="btn btn-primary w-100">Acceder</button>
            <small class="text-muted text-center d-block mt-2">(Puedes usar cualquier texto, solo es una prueba)</small>
        </div>
    </div>

    <div id="appContent" style="display:none;">
        
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
            <a class="navbar-brand" href="#"><i class="fas fa-network-wired"></i> Egunerokoa</a>
            <div class="ms-auto">
                <span class="text-light me-3" id="currentUser"></span>
                <button onclick="exportReport()" class="btn btn-success btn-sm"><i class="fas fa-file-word"></i> Exportar DOCX</button>
                <button onclick="logout()" class="btn btn-outline-light btn-sm ms-2">Logout</button>
            </div>
        </nav>

        <div class="container-fluid mt-4">
            <div class="row">
                <!-- CHECKLIST-STYLE BITACORA -->
                <div class="col-lg-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-clipboard-check"></i> Bitácora del Día - Checklist de Incidencias
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                <i class="fas fa-info-circle"></i> 
                                Selecciona el tipo de incidencia que ocurrió ayer y completa los detalles
                            </p>

                            <!-- Quick Add Buttons -->
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <button class="btn btn-outline-warning quick-add-btn" onclick="openIncidentForm('Retraso')">
                                        <i class="fas fa-clock"></i> Retraso
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-danger quick-add-btn" onclick="openIncidentForm('Falta')">
                                        <i class="fas fa-user-times"></i> Falta
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-info quick-add-btn" onclick="openIncidentForm('Enfermo')">
                                        <i class="fas fa-notes-medical"></i> Enfermo
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-success quick-add-btn" onclick="openIncidentForm('LibrePorHoras')">
                                        <i class="fas fa-calendar-check"></i> Libre por horas
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-primary quick-add-btn" onclick="openIncidentForm('Formacion')">
                                        <i class="fas fa-graduation-cap"></i> Formación
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-dark quick-add-btn" onclick="openIncidentForm('Grave')">
                                        <i class="fas fa-exclamation-triangle"></i> Incidente Grave
                                    </button>
                                </div>
                            </div>

                            <!-- Dynamic Detail Form -->
                            <div id="detailForm" class="quick-detail-form">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <span class="badge badge-tipo" id="formBadge">Tipo</span>
                                        Detalles de la incidencia
                                    </h6>
                                    <button class="btn btn-sm btn-link text-danger" onclick="closeIncidentForm()">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                </div>

                                <div class="row g-2" id="dynamicFields">
                                    <!-- Fields will be injected here -->
                                </div>

                                <button class="btn btn-primary w-100 mt-3" onclick="submitIncident()">
                                    <i class="fas fa-check"></i> Registrar Incidencia
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SUMMARY/LIST SECTION -->
                <div class="col-lg-4">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-secondary text-white">
                            <i class="fas fa-list-check"></i> Resumen del Día
                            <span class="badge bg-light text-dark float-end" id="incidentCount">0</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="scrollable-list">
                                <ul id="bitacora-list" class="list-group list-group-flush">
                                    <li class="list-group-item text-muted text-center py-4">
                                        <i class="fas fa-clipboard-list fa-2x mb-2 d-block"></i>
                                        No hay incidencias registradas
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TASKS & MEETINGS -->
                <div class="col-lg-12">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-secondary text-white d-flex justify-content-between">
                                    <span><i class="fas fa-tasks"></i> Tareas Pendientes</span>
                                    <button class="btn btn-sm btn-light py-0" onclick="toggleTaskForm()">Nueva +</button>
                                </div>
                                <div class="card-body">
                                    <div id="taskForm" class="mb-3 p-3 bg-light border rounded" style="display:none;">
                                        <div class="row g-2">
                                            <div class="col-md-8"><input type="text" id="task-desc" class="form-control" placeholder="Task Description"></div>
                                            <div class="col-md-4"><input type="text" id="task-owner" class="form-control" placeholder="Assigned To"></div>
                                            <div class="col-12"><button onclick="addTask()" class="btn btn-sm btn-dark w-100">Añadir Tarea</button></div>
                                        </div>
                                    </div>
                                    <table class="table table-hover small">
                                        <thead><tr><th>Tarea</th><th>Persona</th><th>Estado</th></tr></thead>
                                        <tbody id="task-list"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-secondary text-white">
                                    <i class="fas fa-handshake"></i> Reuniones del día
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-2">
                                        <input type="time" id="meet-time" class="form-control" style="max-width: 100px;">
                                        <input type="text" id="meet-name" class="form-control" placeholder="Meeting Topic">
                                        <button class="btn btn-secondary" onclick="addMeeting()">Añadir +</button>
                                    </div>
                                    <ul id="meeting-list" class="list-group small"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let appData = {
            bitacora: [],
            tasks: [],
            meetings: [],
            metrics: { calls: 10000000, nds: 0, nda: 0, ans: 0 }
        };

        let currentIncidentType = null;

        // --- FIELD CONFIGURATIONS ---
        const incidentConfigs = {
            'Retraso': {
                badge: 'bg-warning text-dark',
                icon: 'fa-clock',
                fields: [
                    { id: 'persona', label: 'Email de la persona', type: 'email', required: true, col: 12 },
                    { id: 'horas', label: 'Tiempo de retraso', type: 'text', placeholder: 'Ej: 30 minutos', required: true, col: 6 },
                    { id: 'recuperar', label: '¿Cómo recuperará?', type: 'text', required: true, col: 6 },
                    { id: 'motivo', label: 'Motivo del retraso', type: 'textarea', required: true, col: 12 }
                ]
            },
            'Falta': {
                badge: 'bg-danger',
                icon: 'fa-user-times',
                fields: [
                    { id: 'persona', label: 'Email de la persona', type: 'email', required: true, col: 12 },
                    { id: 'horas', label: 'Horas de falta', type: 'text', placeholder: 'Ej: 8 horas', required: true, col: 6 },
                    { id: 'recuperar', label: '¿Cómo recuperará?', type: 'text', required: true, col: 6 },
                    { id: 'motivo', label: 'Motivo de la falta', type: 'textarea', required: true, col: 12 }
                ]
            },
            'Enfermo': {
                badge: 'bg-info',
                icon: 'fa-notes-medical',
                fields: [
                    { id: 'persona', label: 'Email de la persona', type: 'email', required: true, col: 12 },
                    { id: 'horas', label: 'Horas solicitadas', type: 'text', placeholder: 'Ej: Todo el día', required: true, col: 6 },
                    { id: 'recuperar', label: '¿Cómo recuperará?', type: 'text', required: true, col: 6 },
                    { id: 'baja', label: 'Baja médica', type: 'checkbox', col: 12 }
                ]
            },
            'LibrePorHoras': {
                badge: 'bg-success',
                icon: 'fa-calendar-check',
                fields: [
                    { id: 'persona', label: 'Email de la persona', type: 'email', required: true, col: 8 },
                    { id: 'horas', label: 'Horas solicitadas', type: 'text', placeholder: 'Ej: 2 horas', required: true, col: 4 }
                ]
            },
            'Formacion': {
                badge: 'bg-primary',
                icon: 'fa-graduation-cap',
                fields: [
                    { id: 'persona', label: 'Email de la persona', type: 'email', required: true, col: 12 },
                    { id: 'motivo', label: '¿Qué tipo de formación?', type: 'textarea', placeholder: 'Describe el curso o formación', required: true, col: 12 }
                ]
            },
            'Grave': {
                badge: 'bg-dark',
                icon: 'fa-exclamation-triangle',
                fields: [
                    { id: 'motivo', label: 'Describe el incidente grave', type: 'textarea', placeholder: 'Detalles completos del incidente...', required: true, col: 12, rows: 4 }
                ]
            }
        };

        // --- OPEN INCIDENT FORM ---
        function openIncidentForm(tipo) {
            currentIncidentType = tipo;
            const config = incidentConfigs[tipo];
            const form = document.getElementById('detailForm');
            const badge = document.getElementById('formBadge');
            const fieldsContainer = document.getElementById('dynamicFields');

            // Update badge
            badge.className = `badge badge-tipo ${config.badge}`;
            badge.innerHTML = `<i class="fas ${config.icon}"></i> ${tipo}`;

            // Generate fields
            fieldsContainer.innerHTML = config.fields.map(field => {
                if (field.type === 'checkbox') {
                    return `
                        <div class="col-${field.col}">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="field_${field.id}">
                                <label class="form-check-label" for="field_${field.id}">
                                    ${field.label}
                                </label>
                            </div>
                        </div>
                    `;
                } else if (field.type === 'textarea') {
                    return `
                        <div class="col-${field.col}">
                            <label class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                            <textarea class="form-control" id="field_${field.id}" rows="${field.rows || 2}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}></textarea>
                        </div>
                    `;
                } else {
                    return `
                        <div class="col-${field.col}">
                            <label class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                            <input type="${field.type}" class="form-control" id="field_${field.id}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>
                        </div>
                    `;
                }
            }).join('');

            // Show form
            form.classList.add('active');
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function closeIncidentForm() {
            document.getElementById('detailForm').classList.remove('active');
            currentIncidentType = null;
        }

        // --- SUBMIT INCIDENT ---
        function submitIncident() {
            if (!currentIncidentType) return;

            const config = incidentConfigs[currentIncidentType];
            const entry = {
                tipo: currentIncidentType,
                timestamp: new Date().toLocaleString('es-ES')
            };

            // Collect field values
            let isValid = true;
            config.fields.forEach(field => {
                const input = document.getElementById(`field_${field.id}`);
                
                if (field.type === 'checkbox') {
                    entry[field.id] = input.checked ? 'Sí' : 'No';
                } else {
                    entry[field.id] = input.value;
                    
                    // Validate required fields
                    if (field.required && !input.value.trim()) {
                        input.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        input.classList.remove('is-invalid');
                    }
                }
            });

            if (!isValid) {
                alert('Por favor, completa todos los campos obligatorios');
                return;
            }

            // Add to data
            appData.bitacora.push(entry);
            renderBitacora();
            closeIncidentForm();
            
            // Clear form
            config.fields.forEach(field => {
                const input = document.getElementById(`field_${field.id}`);
                if (field.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
                input.classList.remove('is-invalid');
            });
        }

        // --- RENDER BITACORA ---
        function renderBitacora() {
            const list = document.getElementById('bitacora-list');
            const countBadge = document.getElementById('incidentCount');
            
            countBadge.textContent = appData.bitacora.length;

            if (appData.bitacora.length === 0) {
                list.innerHTML = `
                    <li class="list-group-item text-muted text-center py-4">
                        <i class="fas fa-clipboard-list fa-2x mb-2 d-block"></i>
                        No hay incidencias registradas
                    </li>
                `;
                return;
            }

            list.innerHTML = appData.bitacora.map((item, index) => {
                const config = incidentConfigs[item.tipo];
                
                let details = [];
                if (item.persona) details.push(`<strong>Persona:</strong> ${item.persona}`);
                if (item.horas) details.push(`<strong>Horas:</strong> ${item.horas}`);
                if (item.recuperar) details.push(`<strong>Recuperar:</strong> ${item.recuperar}`);
                if (item.motivo) details.push(`<strong>Motivo:</strong> ${item.motivo}`);
                if (item.baja) details.push(`<strong>Baja:</strong> ${item.baja}`);

                return `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="badge ${config.badge}">
                                <i class="fas ${config.icon}"></i> ${item.tipo}
                            </span>
                            <small class="text-muted">${item.timestamp}</small>
                        </div>
                        <div class="bitacora-summary small">
                            ${details.join(' • ')}
                        </div>
                    </li>
                `;
            }).reverse().join('');
        }

        // --- AUTHENTICATION ---
        function login() {
            const user = document.getElementById('username').value;
            if(user) {
            }
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
            document.getElementById('currentUser').innerText = `Welcome, ${user}`;
        }

        function logout() {
            location.reload();
        }

        // --- TASKS LOGIC ---
        function toggleTaskForm() {
            const form = document.getElementById('taskForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        function addTask() {
            const desc = document.getElementById('task-desc').value;
            const owner = document.getElementById('task-owner').value;
            
            if(desc) {
                appData.tasks.push({ desc, owner, status: 'Pending' });
                renderTasks();
                document.getElementById('task-desc').value = '';
                toggleTaskForm();
            }
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            appData.tasks.forEach(item => {
                list.innerHTML += `<tr>
                    <td>${item.desc}</td>
                    <td>${item.owner}</td>
                    <td><span class="badge bg-warning text-dark">${item.status}</span></td>
                </tr>`;
            });
        }

        // --- MEETINGS LOGIC ---
        function addMeeting() {
            const time = document.getElementById('meet-time').value;
            const name = document.getElementById('meet-name').value;

            if(name) {
                appData.meetings.push({ time, name });
                const list = document.getElementById('meeting-list');
                list.innerHTML += `<li class="list-group-item"><i class="far fa-clock"></i> ${time} - ${name}</li>`;
                document.getElementById('meet-name').value = '';
            }
        }

        // --- EXPORT TO DOCX ---
        function exportReport() {
            const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;

            const bitacoraRows = appData.bitacora.map(b => {
                let details = `${b.tipo}`;
                if (b.persona) details += ` - ${b.persona}`;
                if (b.horas) details += ` (${b.horas})`;
                return new Paragraph({ text: `• [${b.timestamp}] ${details}`, bullet: { level: 0 } });
            });

            const taskRows = appData.tasks.map(t => 
                new Paragraph({ text: `• ${t.desc} (${t.owner}) - ${t.status}`, bullet: { level: 0 } })
            );

            const doc = new Document({
                sections: [{
                    properties: {},
                    children: [
                        new Paragraph({ text: "Daily Operations Report", heading: HeadingLevel.TITLE }),
                        new Paragraph({ text: `Date: ${new Date().toLocaleDateString()}`, heading: HeadingLevel.HEADING_2 }),
                        
                        new Paragraph({ text: " ", spacing: { before: 200 } }),
                        new Paragraph({ text: "1. Bitacora (HR & Incidents)", heading: HeadingLevel.HEADING_1 }),
                        ...bitacoraRows,

                        new Paragraph({ text: " ", spacing: { before: 200 } }),
                        new Paragraph({ text: "2. Pending Tasks", heading: HeadingLevel.HEADING_1 }),
                        ...taskRows,
                    ],
                }],
            });

            Packer.toBlob(doc).then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                document.body.appendChild(a);
                a.style = "display: none";
                a.href = url;
                a.download = `Daily_Report_${new Date().toISOString().slice(0,10)}.docx`;
                a.click();
                window.URL.revokeObjectURL(url);
            });
        }
    </script>
</body>
</html>
