<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Egunerokoa - Full Info System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        body { background-color: #f4f7f6; color: #2d3436; font-size: 0.95rem; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        .quick-add-btn { 
            width: 100%; padding: 15px; text-align: left; background: white; 
            border: 1px solid #000000; transition: all 0.2s; font-weight: 600; margin-bottom: 10px;
        }
        /*
        .quick-add-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .btn-retraso { border-left-color: #f6ad55; color: #dd6b20; }
        .btn-falta { border-left-color: #fc8181; color: #e53e3e; }
        .btn-enfermo { border-left-color: #63b3ed; color: #3182ce; }
        .btn-libre { border-left-color: #68d391; color: #38a169; }
        .btn-formacion { border-left-color: #b794f4; color: #805ad5; }
        .btn-grave { border-left-color: #4a5568; color: #2d3748; }
        */
        .form-container { display: none; background: #fff; border: 2px solid #4a90e2; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .form-container.active { display: block; animation: fadeIn 0.3s; }
        
        .remove-btn { color: #feb2b2; cursor: pointer; transition: 0.2s; }
        .remove-btn:hover { color: #f56565; }

        #loginOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .data-label { font-weight: bold; color: #718096; font-size: 0.75rem; text-transform: uppercase; margin-right: 5px; }
        .entry-detail { background: #f8fafc; padding: 2px 8px; border-radius: 4px; margin-right: 5px; display: inline-block; margin-bottom: 2px; }
        .overlay-style {
            display: none;       /* Hidden by default */
            position: fixed;     /* Sticks to the screen even if you scroll */
            top: 0; left: 0;     /* Start at the very top-left corner */
            width: 100%;         /* Cover the whole width */
            height: 100%;        /* Cover the whole height */
            background: rgba(0,0,0,0.5); /* Semi-transparent black */
            z-index: 99999;

            /* THE CENTERING MAGIC */
                   
            justify-content: center; /* Centers horizontally */
            align-items: center;     /* Centers vertically */
        }
        .overlay-style.is-visible {
            display: flex; /* This overrides the 'none' and brings the centering back! */
        }

        .filter-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            min-width: 300px;
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="card p-5" style="width: 380px;">
            <h4 class="text-center mb-4">Control de Acceso</h4>
            <input type="password" id="pass" class="form-control mb-3" placeholder="Contraseña">
            <button onclick="login()" class="btn btn-primary w-100">Entrar</button>
        </div>
    </div>


    <div id="filterOverlay" class="overlay-style">
        <div id="filter-card" class="filter-card">
            <h3>Settings</h3>
            <button id="closeBtn">Close</button>
            <button id="saveConfig">Save</button>
        </div>
    </div>

    <div id="mainApp" style="display:none">
        <nav class="navbar navbar-dark bg-dark px-4 mb-4">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-database me-2"></i> Egunerokoa</span>
            <button onclick="exportJSON()" class="btn btn-outline-info btn-sm">Descargar Backup JSON </button>
            <button id="menuButton" class="btn btn-outline-light btn-sm ms-auto">
                <i class="fas fa-cog"></i> Ajustes de Vista
            </button>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <div class="col-md-8">
                    <div class="card p-4 mb-4">
                        <h5 class="mb-4">Registrar Incidencia</h5>
                        <div class="row" id="categoryButtonsContainer">
                            <!--
                            <div id="retraso" class="col-md-4"><button class="quick-add-btn btn-retraso" onclick="setupForm('Retraso')"> Retraso</button></div>
                            <div id="" class="col-md-4"><button class="quick-add-btn btn-falta" onclick="setupForm('Falta')"> Falta</button></div>
                            <div id="" class="col-md-4"><button class="quick-add-btn btn-enfermo" onclick="setupForm('Enfermo')"> Enfermo</button></div>
                            <div id="" class="col-md-4"><button class="quick-add-btn btn-libre" onclick="setupForm('Libre Por Horas')">Libre por horas</button></div>
                            <div id="" class="col-md-4"><button class="quick-add-btn btn-formacion" onclick="setupForm('Formacion')"> Formación</button></div>
                            <div id="" class="col-md-4"><button class="quick-add-btn btn-grave" onclick="setupForm('Grave')"> Grave</button></div>
                            <div id="" class="col-md-4"><button class="quick-add-btn btn-retraso" onclick="setupForm('RegistroLlaves')"> Registro Llaves</button></div>
                            <div id="" class="col-md-4"><button class="quick-add-btn btn-falta" onclick="setupForm('Hitos')"> Hitos Reseñables</button></div>
                            <div id="" class="col-md-4"><button class="quick-add-btn btn-enfermo" onclick="setupForm('Enfermo2')"> Enfermo</button></div>
                            <div id="" class="col-md-4"><button class="quick-add-btn btn-libre" onclick="setupForm('Libre Por Horas2')">Libre por horas</button></div>
                            <div id="" class="col-md-4"><button class="quick-add-btn btn-formacion" onclick="setupForm('Formacion2')"> Formación</button></div>
                            <div id="" class="col-md-4"><button class="quick-add-btn btn-grave" onclick="setupForm('Grave2')"> Grave</button></div>
                            -->
                        </div>

                        <div id="dynamicForm" class="form-container shadow">
                            <h6 id="formTitle" class="fw-bold mb-3"></h6>
                            <div id="formFields" class="row g-3"></div>
                            <div class="mt-4">
                                <button class="btn btn-primary px-4" onclick="saveEntry()">Guardar en Bitácora</button>
                                <button class="btn btn-light" onclick="$('#dynamicForm').removeClass('active')">Cancelar</button>
                            </div>
                        </div>
                    </div>
                    <div class="card p-3 mb-4 border-start border-primary border-4">
                        <h6 class="fw-bold"><i class="fas fa-key me-2"></i> Gestión de Llaves</h6>
                        <div id="keyList" class="small">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card p-3 mb-4">
                                <h6 class="fw-bold border-bottom pb-2">Tareas del Día</h6>
                                <div class="input-group input-group-sm mb-3">
                                    <input type="text" id="t-desc" class="form-control" placeholder="Nueva tarea...">
                                    <button class="btn btn-dark" onclick="quickEntry('tasks', {desc: $('#t-desc').val()})">Añadir</button>
                                </div>
                                <div id="list-tasks"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3 mb-4">
                                <h6 class="fw-bold border-bottom pb-2">Reuniones</h6>
                                <div class="input-group input-group-sm mb-3">
                                    <input type="time" id="m-time" class="form-control">
                                    <input type="text" id="m-name" class="form-control" placeholder="Asunto...">
                                    <button class="btn btn-dark" onclick="quickEntry('meetings', {time: $('#m-time').val(), name: $('#m-name').val()})">+</button>
                                </div>
                                <div id="list-meetings"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white fw-bold d-flex justify-content-between">
                            <span>Actividad de Hoy</span>
                            <span class="badge bg-primary" id="todayCount">0</span>
                        </div>
                        <div class="card-body p-0">
                            <div id="list-bitacora" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-5">
                <div class="col-12 mb-5">
                    <div class="card border-0 shadow-lg">
                        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-history me-2"></i> Auditoría de Días Previos</span>
                            <input type="date" id="histDate" class="form-control form-control-sm w-auto">
                        </div>
                        <div class="card-body bg-light" id="histContent">
                            <p class="text-center text-muted my-5">Seleccione una fecha para ver el reporte completo.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>



        const config = {
            'Retraso': { color: 'text-warning', fields: [{n:'p', l:'Persona', t:'text'}, {n:'h', l:'Horas', t:'text'}, {n:'r', l:'Recuperación', t:'text'}, {n:'m', l:'Motivo', t:'text'}] },
            'Falta': { color: 'text-danger', fields: [{n:'p', l:'Persona', t:'text'}, {n:'m', l:'Motivo', t:'text'}] },
            'Enfermo': { color: 'text-info', fields: [{n:'p', l:'Persona', t:'text'}, {n:'baja', l:'¿Tiene Baja Médica?', t:'check'}] },
            'Libre Por Horas': { color: 'text-success', fields: [{n:'p', l:'Persona', t:'text'}, {n:'h', l:'Horas', t:'text'}] },
            'Formacion': { color: 'text-primary', fields: [{n:'p', l:'Persona', t:'text'}, {n:'m', l:'Curso', t:'text'}] },
            'Grave': { color: 'text-dark', fields: [{n:'m', l:'Descripción', t:'text'}] },
            'Hitos': { color: 'text-primary', icon: 'fa-star', fields: [{n:'desc', l:'Hito Reseñable', t:'text'}, {n:'cli', l:'Cliente', t:'text'}] },
            'Mejoras': { color: 'text-info', icon: 'fa-lightbulb', fields: [{n:'m', l:'Propuesta de Mejora', t:'text'}, {n:'imp', l:'Impacto (1-10)', t:'text'}] },
            'Necesidades': { color: 'text-danger', icon: 'fa-exclamation-triangle', fields: [{n:'n', l:'Descripción', t:'text'}, {n:'u', l:'Urgencia', t:'text'}] },
            'Seguimiento': { color: 'text-secondary', icon: 'fa-redo', fields: [{n:'cli', l:'Cliente', t:'text'}, {n:'acc', l:'Acción Realizada', t:'text'}, {n:'next', l:'Próximo Paso', t:'text'}] }
        };



        let data = JSON.parse(localStorage.getItem('egunerokoa_v3')) || {
            bitacora: [], 
            tasks: [], 
            meetings: [], 
            keys: [
                { id: 1, name: "Principal", status: "In", holder: "Oficina" },
                { id: 2, name: "Archivo", status: "In", holder: "Oficina" }
            ],
            timeLogs: [], // For "trabajos que se están realizando"
            // This defines the "Permanent" templates for each role
            profiles: {
                "admin": Object.keys(config), 
                "staff": ["Retraso", "Hitos", "Seguimiento"], 
                "default": ["Retraso", "Falta"]
            },
            // This is the "Live" list the UI actually draws
            visible: Object.keys(config), 
            currentUser: "default" 
        };
        function login() {
            let pass = $('#pass').val();
            
            if (pass === '1234') {
                data.currentUser = "admin";
            } else if (pass === '5555') {
                data.currentUser = "staff";
            } else {
                data.currentUser = "default";
            }

            // IMPORTANT: Reset the visible buttons to the profile's default
            data.visible = data.profiles[data.currentUser];

            $('#loginOverlay').hide();
            $('#mainApp').show();
            
            sync(); 
        }
            
        const sync = () => { 
            localStorage.setItem('egunerokoa_v3', 
            JSON.stringify(data)); 
            render(); 
            renderButtons();
            renderKeys();
        };



        // When the menu button is clicked
        $('#menuButton').click(function() {
           $('#filterOverlay').addClass('is-visible');
                let fieldList = [];
                let html = "<h3>Settings</h3>"
                let fieldConfig;
                $.map( config, function( val, i ) {
                    fieldList.push(i)
                });
                fieldList.forEach(f => {
                    // We check if 'f' exists in our saved data.visible list
                    let isChecked = data.visible.includes(f) ? "checked" : "";
                    
                    html += `<div>${f} <input id='${f}' type='checkbox' ${isChecked} /></div>`;
                });
                html += `
                </div>
                <button id="closeBtn" class="btn btn-secondary">Close</button>
                <button id="saveConfig" class="btn btn-primary">Save</button>`; 
                $('#filter-card').html(html);
        });

        $(document).on('click', '#saveConfig', function() {
            let visibleCategories = [];

            // 2. Select ALL checkboxes inside your filter-card
            // We use a specific class like '.filter-check' to be precise
            $('#filter-card input[type="checkbox"]:checked').each(function() {
            // 'this' refers to the current checkbox the loop is touching
            visibleCategories.push($(this).attr('id')); 
            });

            data.visible = visibleCategories;

            // Save to localStorage and refresh the UI
            sync();
            console.log("Categories to show:", visibleCategories);
            
            $('#filterOverlay').removeClass('is-visible');
        });


        // 2. FOR THE CLOSE BUTTON
        $(document).on('click', '#closeBtn', function() {
            console.log("CLOSE CLICKED!");
            $('#filterOverlay').removeClass('is-visible');
        });

        let activeCat = null;
        let currentConfig = null;

        function setupForm(cat) {
            activeCat = cat;
            $('#formTitle').html(`<span class="${config[cat].color}">${cat}</span>`);
            $('#formFields').html(config[cat].fields.map(f => `
                <div class="${f.t === 'check' ? 'col-12' : 'col-md-6'}">
                    ${f.t === 'check' ? `
                        <div class="form-check p-3 border rounded bg-light mt-2">
                            <input class="form-check-input ms-0 me-2" type="checkbox" id="in_${f.n}">
                            <label class="form-check-label fw-bold" for="in_${f.n}">${f.l}</label>
                        </div>
                    ` : `
                        <label class="small fw-bold text-muted">${f.l}</label>
                        <input id="in_${f.n}" class="form-control">
                    `}
                </div>
            `).join(''));
            $('#dynamicForm').addClass('active');
        }

        function saveEntry() {
            let entry = { id: Date.now(), type: activeCat, date: today(), time: now() };
            config[activeCat].fields.forEach(f => {
                const el = $(`#in_${f.n}`);
                entry[f.n] = f.t === 'check' ? el.is(':checked') : el.val();
            });
            data.bitacora.push(entry);
            $('#dynamicForm').removeClass('active');
            sync();
        }

        function toggleKey(id) {
            let key = data.keys.find(k => k.id === id);
            if (key.status === "In") {
                let person = prompt("¿Quién se lleva la llave?");
                if (!person) return;
                key.status = "Out";
                key.holder = person;
            } else {
                key.status = "In";
                key.holder = "Oficina";
            }
            sync();
        }

        // Update your render function to include this:
        function renderKeys() {
            $('#keyList').html(data.keys.map(k => `
                <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-light rounded">
                    <span><strong>${k.name}</strong>: ${k.holder}</span>
                    <button onclick="toggleKey(${k.id})" class="btn btn-sm ${k.status === 'In' ? 'btn-success' : 'btn-warning'}">
                        ${k.status === 'In' ? 'Disponible' : 'Fuera'}
                    </button>
                </div>
            `).join(''));
        }

        function quickEntry(cat, obj) {
            if(!Object.values(obj)[0]) return;
            obj.id = Date.now(); obj.date = today();
            data[cat].push(obj); sync();
            $('#t-desc, #m-name').val('');
        }

        function remove(id, cat) {
            if(confirm('¿Eliminar este registro permanentemente?')) {
                data[cat] = data[cat].filter(i => i.id !== id);
                sync();
                if($('#histDate').val()) loadHistory($('#histDate').val());
            }
        }

        // --- HELPER TO RENDER FULL DETAILS ---
        function getDetailHtml(e) {
            let html = '';
            const conf = config[e.type];
            conf.fields.forEach(f => {
                const val = e[f.n];
                if(f.t === 'check') {
                    if(val) html += `<span class="badge bg-danger">CON BAJA</span> `;
                } else if(val) {
                    html += `<div class="entry-detail"><span class="data-label">${f.l}:</span>${val}</div>`;
                }
            });
            return html;
        }

        function render() {
            const isToday = (e) => e.date === today();
            const todayBits = data.bitacora.filter(isToday);
            $('#todayCount').text(todayBits.length);

            $('#list-bitacora').html(todayBits.reverse().map(e => `
                <div class="list-group-item p-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="fw-bold ${config[e.type].color}"><i class="fas fa-circle small me-1"></i> ${e.type}</span>
                        <span class="text-muted small">${e.time}</span>
                    </div>
                    <div class="small text-secondary">
                        ${getDetailHtml(e)}
                    </div>
                    <div class="text-end mt-1"><i class="fas fa-trash-alt remove-btn" onclick="remove(${e.id}, 'bitacora')"></i></div>
                </div>
            `).join('') || '<p class="text-center text-muted p-4">No hay registros hoy</p>');

            $('#list-tasks').html(data.tasks.filter(isToday).map(e => `<div class="d-flex justify-content-between border-bottom py-2 small"><span>• ${e.desc}</span><i class="fas fa-times remove-btn" onclick="remove(${e.id}, 'tasks')"></i></div>`).join(''));
            $('#list-meetings').html(data.meetings.filter(isToday).map(e => `<div class="d-flex justify-content-between border-bottom py-2 small"><span><b>${e.time}</b> ${e.name}</span><i class="fas fa-times remove-btn" onclick="remove(${e.id}, 'meetings')"></i></div>`).join(''));

        }


        function renderButtons() {
            // Hide the settings cog if the user is not an admin
            if (data.currentUser !== 'admin') {
                $('#menuButton').hide();
            } else {
                $('#menuButton').show();
            }
            let html = "";
            // We draw based on the currently active "visible" list
            let currentVisible = data.visible || [];

            Object.keys(config).forEach(cat => {
                if (!currentVisible.includes(cat)) return;

                html += `
                    <div class="col-md-4 mb-2">
                        <button class="quick-add-btn btn-${cat.toLowerCase().replace(/\s+/g, '')}" 
                                onclick="setupForm('${cat}')">
                            <i class="fas fa-tag small me-2"></i> ${cat}
                        </button>
                    </div>`;
            });
            $('#categoryButtonsContainer').html(html);
        }


        function loadHistory(d) {
            const filter = (arr) => arr.filter(x => x.date === d);
            const b = filter(data.bitacora);
            const t = filter(data.tasks);
            const m = filter(data.meetings);

            $('#histContent').html(`
                <div class="row">
                    <div class="col-md-5 border-end"><h6><i class="fas fa-list"></i> Actividad</h6>
                        ${b.map(e => `<div class="p-3 bg-white rounded mb-2 small shadow-sm">
                            <div class="d-flex justify-content-between"><b>${e.time}</b> <span class="${config[e.type].color} fw-bold">${e.type}</span></div>
                            <div class="mt-1">${getDetailHtml(e)}</div>
                            <i class="fas fa-trash-alt remove-btn float-end mt-1" onclick="remove(${e.id}, 'bitacora')"></i>
                        </div>`).join('') || '---'}
                    </div>
                    <div class="col-md-3 border-end"><h6><i class="fas fa-check-square"></i> Tareas</h6>
                        ${t.map(e => `<div class="p-2 bg-white rounded mb-1 small shadow-sm">${e.desc} <i class="fas fa-trash-alt remove-btn float-end" onclick="remove(${e.id}, 'tasks')"></i></div>`).join('') || '---'}
                    </div>
                    <div class="col-md-4"><h6><i class="fas fa-handshake"></i> Reuniones</h6>
                        ${m.map(e => `<div class="p-2 bg-white rounded mb-1 small shadow-sm"><b>${e.time}</b> ${e.name} <i class="fas fa-trash-alt remove-btn float-end" onclick="remove(${e.id}, 'meetings')"></i></div>`).join('') || '---'}
                    </div>
                </div>
            `);
        }

        const today = () => new Date().toLocaleDateString('en-CA');
        const now = () => new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        function exportJSON() {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `Egunerokoa_Backup_${today()}.json`; a.click();
        }
        $('#histDate').on('change', function() { loadHistory($(this).val()); });
        $(document).ready(function() {
            // 1. First, make sure 'data' is loaded 
            // (This is already handled by your 'let data = ...' at the top)

            // 2. Trigger the initial render
            // This fills the empty <div> containers with actual content
            render();
            renderButtons();

            // 3. Optional: If you want to start at the login screen
            $('#mainApp').hide();
            $('#loginOverlay').show();
            
            console.log("App Initialized: Data loaded and UI rendered.");
        });
    </script>
</body>
</html>
